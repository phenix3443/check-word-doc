# 核心概念说明

## ⚠️ 重要：容易混淆的概念

本文档澄清两组容易混淆的概念：
1. **基础规则 vs 文档自定义规则**（规则的分类）
2. **规则配置 vs 规则类**（配置 vs 代码）

---

## 一、规则的分类（只有两种）

### 1. 基础规则 (Base Rules)

**定义**: 适用于**所有文档**的基础检查规则

**位置**: `config/base.yaml`

**特点**:
- ✅ 所有文档都必须遵守
- ✅ 与文档类型无关
- ✅ 所有模板都应该导入

**示例**:
- 段落末尾标点检查
- 中文字符间空格检查
- 引号配对检查
- 参考文献存在性检查

### 2. 文档自定义规则 (Document-Specific Rules)

**定义**: 针对**特定文档类型或项目**的额外规则

**位置**: 
- 模板配置：`config/data_paper_template.yaml` 等
- 用户配置：`my_project.yaml` 等

**特点**:
- ✅ 特定于文档类型或项目
- ✅ 导入基础规则后添加自定义规则
- ✅ 模板配置本质上也是文档自定义规则（只是我们预设的）

**示例**:
- 封面字体要求（数据论文 vs 学位论文不同）
- 特定章节要求（数据论文特有的章节）
- 项目特定的格式要求

---

## 二、配置 vs 代码（容易混淆！）

### 1. 规则配置 (Rule Configuration) - YAML 文件

**定义**: 配置文件中定义的规则（YAML 格式）

**位置**: `config/*.yaml`

**定义**: 抽象的 Python 类，通过**参数配置**适配不同检查需求

**位置**: `script/rules/*.py` (代码文件)

**特点**:
- ✅ 一个类可以服务多个规则 ID
- ✅ 通过参数控制行为
- ✅ 减少代码重复

**示例**:
```python
# script/rules/structure_rules.py

class PresenceRule(FinalizeRule):
    """通用规则类：检查元素是否存在"""
    
    def __init__(self, id, keywords, ...):
        # 参数化
        pass
```

**使用**:
```yaml
# 同一个 PresenceRule 类，不同参数 → 不同规则

- id: "COV001"
  params:
    keywords: ["数据集", "作者"]  # 检查封面

- id: "TOC001"
  params:
    title_text: "目录"            # 检查目录

- id: "REF001"
  params:
    title_text: "参考文献"        # 检查参考文献
```

---

## 2. 三层架构

```
┌─────────────────────────────────────────────────────────────┐
│ Layer 1: 通用规则类（Python 代码）                            │
│                                                               │
│ 文件位置: script/rules/                                       │
│   - structure_rules.py  (PresenceRule 等)                    │
│   - paragraph_rules.py  (PunctuationRule 等)                 │
│   - format_rules.py     (FontStyleRule 等) 🆕                │
│                                                               │
│ 作用: 定义"如何检查"                                          │
└─────────────────────────────────────────────────────────────┘
                            ↓ 被使用
┌─────────────────────────────────────────────────────────────┐
│ Layer 2a: 通用规则配置（所有文档共用）                         │
│                                                               │
│ 文件位置: config/base.yaml                                    │
│                                                               │
│ 内容:                                                         │
│   - PAR003: 段落末尾标点                                      │
│   - PAR004: 中文空格                                          │
│   - PAR006: 引号配对                                          │
│   - REF001: 参考文献存在                                      │
│   ... (所有文档都需要的基础规则)                               │
│                                                               │
│ 作用: 定义"所有文档都要检查什么"                               │
└─────────────────────────────────────────────────────────────┘
                            ↓ 被导入
┌─────────────────────────────────────────────────────────────┐
│ Layer 2b: 文档类型特定配置                                    │
│                                                               │
│ 文件位置: config/                                             │
│   - data_paper_template.yaml    (数据论文)                   │
│   - thesis_template.yaml        (学位论文)                   │
│   - report_template.yaml        (技术报告)                   │
│                                                               │
│ 内容:                                                         │
│   import: ["base.yaml"]  ← 导入通用规则                      │
│   rules:                                                      │
│     - FONT001: 封面标题字体 (数据论文特有)                     │
│     - STRUCT001: 必需章节 (数据论文特有)                      │
│                                                               │
│ 作用: 定义"特定文档类型要检查什么"                             │
└─────────────────────────────────────────────────────────────┘
                            ↓ 被导入/覆盖
┌─────────────────────────────────────────────────────────────┐
│ Layer 3: 用户项目自定义配置                                   │
│                                                               │
│ 文件位置: 用户项目目录                                         │
│   - my_project.yaml                                          │
│                                                               │
│ 内容:                                                         │
│   import: ["data_paper_template.yaml"]                       │
│   rules:                                                      │
│     - PAR003:                                                 │
│       enabled: false  ← 禁用某个规则                          │
│                                                               │
│ 作用: 定义"我的项目要检查什么"                                 │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 配置文件说明

### config/base.yaml - 通用规则（所有文档）

```yaml
# 所有文档都必须遵守的基础规则

rules:
  - id: "PAR003"  # 段落标点
  - id: "PAR004"  # 中文空格
  - id: "PAR006"  # 引号配对
  - id: "REF001"  # 参考文献存在
  # ...
```

**谁使用**: 所有文档类型都应该导入

---

### config/data_paper_template.yaml - 数据论文模板

```yaml
# 数据论文特定的检查规则

import:
  - "base.yaml"  # 导入通用规则

rules:
  # 数据论文特有的规则
  - id: "FONT001"
    params:
      description: "封面标题必须使用黑体3号"  # 数据论文特定要求
      ...
  
  - id: "STRUCT001"
    params:
      description: "必须包含数据采集章节"      # 数据论文特定章节
      ...
```

**谁使用**: 检查数据论文时使用

---

### config/example_format_rules.yaml - 规则类使用示例

```yaml
# 这不是"通用规则"！
# 这是展示如何使用 format_rules.py 中新增规则类的示例

rules:
  - id: "FONT001"  # 使用 FontStyleRule
  - id: "PAR001"   # 使用 ParagraphFormatRule
  - id: "UNIT001"  # 使用 MatchingRule
```

**谁使用**: 开发者参考，了解如何使用新的规则类

---

## 4. 总结

| 概念 | 含义 | 位置 | 作用 |
|-----|------|-----|------|
| **通用规则** | 所有文档都要遵守的规则 | `config/base.yaml` | 配置数据 |
| **通用规则类** | 抽象的规则类 | `script/rules/*.py` | Python 代码 |
| **文档模板配置** | 特定文档类型的规则 | `config/*_template.yaml` | 配置数据 |
| **规则类使用示例** | 展示规则类用法 | `config/example_*.yaml` | 示例/文档 |

**关键区别**:
- `base.yaml` = 通用**规则**（配置）← 所有文档共用
- `format_rules.py` = 通用**规则类**（代码）← 被不同规则使用
